(function () {
    "use strict";
    /*
    // === KONFIGURACJA ===
    var ChatWidgetConfig = (function () {
      var defaults = {
        webhook: {
          url: "https://workflower.fallowdeer.pl/webhook/5cf860be-e793-4705-baad-6402097c0b5a",
          route: "general"
        },
        style: {
          primaryColor: "#bb3f40",
          secondaryColor: "#ea3235",
          backgroundColor: "#ffffff",
          fontColor: "#2a2a2a",
          position: "right" // right | left
        },
        uiText: {
          header: "Asystent Malek",
          welcome: "Cześć, jestem Malek. Jak mogę Ci pomóc?",
          inputPlaceholder: "Napisz tu o co chcesz zapytać...",
          btnSend: "Wyślij",
          btnOpenAria: "Otwórz czat",
          btnCloseAria: "Zamknij czat",
          btnProduct: "Sprawdź",
          reasonLabel: "Dlaczego ten produkt:"
        }
      };
  
      // Prosta, płytko‑głęboka funkcja mergująca obiekty (dla webhook/style/uiText)
      function merge(target, source) {
        if (!source) return target;
        for (var key in source) {
          if (!Object.prototype.hasOwnProperty.call(source, key)) continue;
          var value = source[key];
          if (value && typeof value === "object" && !Array.isArray(value)) {
            if (!target[key] || typeof target[key] !== "object") {
              target[key] = {};
            }
            merge(target[key], value);
          } else {
            target[key] = value;
          }
        }
        return target;
      }
  
      if (typeof window !== "undefined" && window.ChatWidgetConfig) {
        return merge(defaults, window.ChatWidgetConfig || {});
      }
  
      return defaults;
    })();
    */
    // === KONFIGURACJA ===
    var ChatWidgetConfig = (function () {
      var defaults = {
        webhook: {
          url: "https://workflower.fallowdeer.pl/webhook/5cf860be-e793-4705-baad-6402097c0b5a",
          route: "general"
        },
        style: {
          primaryColor: "#bb3f40",
          secondaryColor: "#ea3235",
          backgroundColor: "#ffffff",
          fontColor: "#2a2a2a",
          position: "right" // right | left
        },
        uiText: {
          header: "Asystent Malek",
          welcome: "Cześć, jestem Malek. Jak mogę Ci pomóc?",
          inputPlaceholder: "Napisz tu o co chcesz zapytać...",
          btnSend: "Wyślij",
          btnOpenAria: "Otwórz czat",
          btnCloseAria: "Zamknij czat",
          btnProduct: "Sprawdź",
          reasonLabel: "Dlaczego ten produkt:"
        }
      };

      // Prosta, płytko‑głęboka funkcja mergująca obiekty (dla webhook/style/uiText)
      function merge(target, source) {
        if (!source) return target;
        for (var key in source) {
          if (!Object.prototype.hasOwnProperty.call(source, key)) continue;
          var value = source[key];
          if (value && typeof value === "object" && !Array.isArray(value)) {
            if (!target[key] || typeof target[key] !== "object") {
              target[key] = {};
            }
            merge(target[key], value);
          } else {
            target[key] = value;
          }
        }
        return target;
      }

      if (typeof window !== "undefined" && window.ChatWidgetConfig) {
        return merge(defaults, window.ChatWidgetConfig || {});
      }

      return defaults;
    })();
  
    // === STYLE ===
    var css = `
      :root{
        --app-height:100%;
        --chat-primary:${ChatWidgetConfig.style.primaryColor};
        --chat-secondary:${ChatWidgetConfig.style.secondaryColor};
        --chat-white:#fff;
        --chat-text:${ChatWidgetConfig.style.fontColor};
        --chat-border:#e7e7e9;
        --chip:#f3f3f4;
        --shadow:0 6px 18px rgba(0,0,0,.12);
        --radius:14px;
        --radius-sm:10px;
        --radius-xs:8px;
      }
      .cw-root{font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .cw-reset{box-sizing:border-box;margin:0;padding:0}
      #chat-widget-button{
        position:fixed; bottom:20px; ${ChatWidgetConfig.style.position==="left"?"left:20px;":"right:20px;"}
        background:var(--chat-primary); color:var(--chat-white); border:none;
        width:50px; height:50px; border-radius:50%; cursor:pointer; z-index:100001;
        display:flex; align-items:center; justify-content:center;
        box-shadow:0 4px 6px rgba(0,0,0,.2);
      }
      #chat-widget-button svg{width:26px;height:26px;stroke:#fff;transition:transform .2s ease}
      #chat-widget-button:hover svg{transform:scale(1.06)}
      #chat-widget-container{
        position:fixed; bottom:20px; ${ChatWidgetConfig.style.position==="left"?"left:20px;":"right:20px;"}
        width:350px; height:500px; background:${ChatWidgetConfig.style.backgroundColor};
        border-radius:var(--radius); box-shadow:var(--shadow); display:none; flex-direction:column;
        z-index:100000; overflow:hidden; transition:all .3s ease-in-out;
      }
      @media (max-width:768px){
        #chat-widget-container.mobile-fullscreen{
          width:100vw !important; height:var(--app-height) !important; top:0 !important;
          left:0 !important; right:0 !important; bottom:0 !important; border-radius:0 !important;
        }
      }
      #chat-widget-header{
        background:var(--chat-primary); color:var(--chat-white); padding:16px 18px;
        font-weight:600; display:flex; justify-content:space-between; align-items:center; font-size:16px;
      }
      #chat-widget-close-button{
        background:none; border:none; color:var(--chat-white); font-size:18px; cursor:pointer; line-height:1;
      }
      #chat-widget-body{
        flex:1; padding:16px; overflow-y:auto; display:flex; flex-direction:column; gap:12px;
        color:var(--chat-text);
      }
      .user-message{
        align-self:flex-end; background:var(--chip); color:var(--chat-text); border-radius:var(--radius-xs);
        padding:10px 12px; max-width:80%; font-size:14px;
      }
      .bot-message{
        align-self:flex-start; background:var(--chat-primary); color:var(--chat-white);
        border-radius:var(--radius-xs); padding:12px; max-width:100%; font-size:14px;
      }
      .bot-message a{color:#fff; text-decoration:underline}
      #chat-widget-footer{
        padding:12px; border-top:1px solid var(--chat-border); display:flex; gap:8px;
      }
      #chat-widget-input{
        flex:1; padding:8px; border:1px solid var(--chat-border); border-radius:var(--radius-xs); outline:none;
      }
      #chat-widget-send{
        background:var(--chat-primary); color:var(--chat-white); border:none; padding:8px 14px;
        border-radius:var(--radius-xs); cursor:pointer; font-weight:600;
      }
      .typing-indicator{display:flex; align-items:center; gap:4px; align-self:flex-start}
      .typing-indicator .dot{width:8px; height:8px; border-radius:50%; background:var(--chat-secondary);
        animation:bounce 1.4s infinite ease-in-out}
      .typing-indicator .dot:nth-child(2){animation-delay:.2s}
      .typing-indicator .dot:nth-child(3){animation-delay:.4s}
      @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
      .product-card{
        border:1px solid var(--chat-border); border-radius:var(--radius-sm); padding:12px; background:#fff; color:var(--chat-text);
        box-shadow:0 2px 6px rgba(0,0,0,.06); display:flex; flex-direction:column; gap:10px;
      }
      .product-top{display:flex; gap:12px; align-items:flex-start}
      .product-image{width:80px; height:80px; object-fit:cover; border-radius:var(--radius-xs); border:1px solid var(--chat-border); flex-shrink:0}
      .product-info{flex:1; display:flex; flex-direction:column; gap:6px}
      .product-title{font-weight:600; font-size:15px; line-height:1.3}
      .product-price{font-size:14px; font-weight:500; color:var(--chat-secondary)}
      .product-button{
        margin-top:auto; padding:8px 12px; border:none; background:var(--chat-primary); color:#fff;
        border-radius:var(--radius-xs); text-decoration:none; font-size:14px; font-weight:600; text-align:center; display:inline-block;
      }
      .product-reason{font-size:13px; color:#555; line-height:1.4}
      .product-reason strong{color:var(--chat-secondary)}
      .order-card{
        border:1px solid var(--chat-border); border-radius:var(--radius-sm); padding:12px; background:#fff; color:var(--chat-text);
        box-shadow:0 2px 6px rgba(0,0,0,.06); display:flex; flex-direction:column;
      }
      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 8px;
        margin-bottom: 10px;
      }
  
      .order-header strong {
        color: #333;
        font-size: 15px;
      }
  
      .order-header .order-status {
        background-color: #e8f6ee;
        color: #007b00;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 13px;
      }
  
      /* Dane kontaktowe */
      .order-info {
        margin-bottom: 10px;
      }
  
      .order-info div {
        margin: 3px 0;
      }
  
      .order-info strong {
        color: #444;
      }
  
      /* Tabela timeline */
      .timeline {
        margin-top: 8px;
      }
  
      .timeline h3 {
        font-size: 14px;
        margin-bottom: 6px;
        color: #333;
      }
  
      .timeline table {
        width: 100%;
        border-collapse: collapse;
        background: #fafafa;
        border-radius: 8px;
        overflow: hidden;
      }
  
      .timeline th {
        background-color: #f3f3f3;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        padding: 8px;
        border-bottom: 1px solid #e0e0e0;
      }
  
      .timeline td {
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
        color: #333;
      }
  
      .timeline tr:last-child td {
        border-bottom: none;
      }
    `;
  
    // === UTILS ===
    function injectStyle(cssText) {
      var s = document.createElement("style");
      s.type = "text/css";
      s.appendChild(document.createTextNode(cssText));
      document.head.appendChild(s);
    }
    function setAppHeight() {
      document.documentElement.style.setProperty("--app-height", window.innerHeight + "px");
    }
    function markdownToHTML(md) {
      if (!md) return "";
      return md
        .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
        .replace(/(^|\s)(https?:\/\/[^\s<]+)/g, '$1<a href="$2" target="_blank" rel="noopener noreferrer">$2</a>')
        .replace(/^### (.*$)/gim, "<h3>$1</h3>")
        .replace(/^## (.*$)/gim, "<h2>$1</h2>")
        .replace(/^# (.*$)/gim, "<h1>$1</h1>")
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/^- (.*?)(?=\n|$)/gm, "<li>$1</li>")
        .replace(/(?:\r\n|\r|\n)/g, "<br>");
    }
    function getChatId() {
      try {
        var sid = sessionStorage.getItem("chatId");
        if (!sid) {
          sid = "chat_" + Math.random().toString(36).slice(2, 11);
          sessionStorage.setItem("chatId", sid);
        }
        return sid;
      } catch (e) {
        return "chat_" + Math.random().toString(36).slice(2, 11);
      }
    }
  
    // === DOM ===
    function buildDOM() {
      var container = document.createElement("div");
      container.className = "cw-root";
      container.innerHTML = `
        <button id="chat-widget-button" aria-label="${ChatWidgetConfig.uiText.btnOpenAria}">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 4h16v12H5.17 L4 17.17V4z" stroke="white" stroke-width="2" fill="none" stroke-linejoin="round"/>
          </svg>
        </button>
  
        <div id="chat-widget-container" class="cw-reset">
          <div id="chat-widget-header" class="cw-reset">
            <span>${ChatWidgetConfig.uiText.header}</span>
            <button id="chat-widget-close-button" aria-label="${ChatWidgetConfig.uiText.btnCloseAria}" title="${ChatWidgetConfig.uiText.btnCloseAria}">×</button>
          </div>
          <div id="chat-widget-body" class="cw-reset">
            <div class="bot-message">${ChatWidgetConfig.uiText.welcome}</div>
          </div>
          <div id="chat-widget-footer" class="cw-reset">
            <input type="text" id="chat-widget-input" placeholder="${ChatWidgetConfig.uiText.inputPlaceholder}" />
            <button id="chat-widget-send">${ChatWidgetConfig.uiText.btnSend}</button>
          </div>
        </div>
      `;
      document.body.appendChild(container);
    }
  
    // === LOGIKA ===
    function init() {
      injectStyle(css);
      setAppHeight();
      window.addEventListener("resize", setAppHeight);
      buildDOM();
  
      var chatButton = document.getElementById("chat-widget-button");
      var chatContainer = document.getElementById("chat-widget-container");
      var closeButton = document.getElementById("chat-widget-close-button");
      var sendButton = document.getElementById("chat-widget-send");
      var inputField = document.getElementById("chat-widget-input");
      var chatBody = document.getElementById("chat-widget-body");
      var chatHeader = document.getElementById("chat-widget-header");
  
      // Zastosuj kolory z konfiguracji (część już w CSS zmiennych)
      chatHeader.style.backgroundColor = ChatWidgetConfig.style.primaryColor;
      sendButton.style.backgroundColor = ChatWidgetConfig.style.primaryColor;
      chatContainer.style.backgroundColor = ChatWidgetConfig.style.backgroundColor;
      chatBody.style.color = ChatWidgetConfig.style.fontColor;
  
      chatButton.addEventListener("click", function () {
        chatContainer.classList.add("mobile-fullscreen");
        chatContainer.style.display = "flex";
        chatButton.style.display = "none";
      });
      closeButton.addEventListener("click", function () {
        chatContainer.style.display = "none";
        chatButton.style.display = "flex";
      });
  
      function appendTyping() {
        var t = document.createElement("div");
        t.className = "typing-indicator";
        t.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
        chatBody.appendChild(t);
        chatBody.scrollTop = chatBody.scrollHeight;
        return t;
      }
  
      function sendMessage() {
        var messageText = (inputField.value || "").trim();
        if (!messageText) return;
  
        var userMessage = document.createElement("div");
        userMessage.className = "user-message";
        userMessage.textContent = messageText;
        chatBody.appendChild(userMessage);
        chatBody.scrollTop = chatBody.scrollHeight;
  
        var typing = appendTyping();
        var chatId = getChatId();
  
        fetch(ChatWidgetConfig.webhook.url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chatId: chatId, message: messageText, route: ChatWidgetConfig.webhook.route })
        })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          try { typing.remove(); } catch(e){}
          var rawText = (data && data[0] && data[0].output) ? data[0].output : "Przepraszam, nie mogę odpowiedzieć. Spróbuj ponownie.";
          var jsonBlock = null;
  
          try {
            var match = rawText.match(/```json\s*([\s\S]*?)```/i);
            if (match) jsonBlock = JSON.parse(match[1].trim());
          } catch (e) {
            console.warn("Brak poprawnego JSON w odpowiedzi:", e);
          }
  
          var botContainer = document.createElement("div");
          botContainer.className = "bot-message";
  
          if (jsonBlock && jsonBlock.type === "product_list" && Array.isArray(jsonBlock.products)) {
            var descriptionText = rawText.replace(/```json\s*([\s\S]*?)```/i, "").trim();
            if (descriptionText) {
              var desc = document.createElement("div");
              desc.innerHTML = markdownToHTML(descriptionText);
              desc.style.marginBottom = "8px";
              botContainer.appendChild(desc);
            }
            jsonBlock.products.forEach(function (p) {
              var card = document.createElement("div");
              card.className = "product-card";
              card.innerHTML = `
                <div class="product-top">
                  <img src="${(p.image||"")}" alt="${(p.title||"")}" class="product-image" />
                  <div class="product-info">
                    <div class="product-title">${(p.title||"")}</div>
                    <div class="product-price">${(p.price||"")}</div>
                    <a href="${(p.link||"#")}" target="_blank" rel="noopener noreferrer" class="product-button">${ChatWidgetConfig.uiText.btnProduct}</a>
                  </div>
                </div>
                ${p.description ? `<div class="product-reason"><strong>${ChatWidgetConfig.uiText.reasonLabel}</strong> ${p.description}</div>` : ""}
              `;
              botContainer.appendChild(card);
            });
          } else if (jsonBlock && jsonBlock.type === "order_status" && Array.isArray(jsonBlock.order_info)) {
              var descriptionText = rawText.replace(/```json\s*([\s\S]*?)```/i, "").trim();
            if (descriptionText) {
              var desc = document.createElement("div");
              desc.innerHTML = markdownToHTML(descriptionText);
              desc.style.marginBottom = "8px";
              botContainer.appendChild(desc);
            }
            jsonBlock.order_info.forEach(function (p) {
              var card = document.createElement("div");
              card.className = "order-card";
              card.innerHTML = `
                <div class="order-header">
                  <div><strong>Numer zamówienia:</strong> ${(p.order_number||"")}</div>
                  <div class="order-status"><strong>Status: </strong>${(p.status||"")}</div>
                </div>
                <div class="order-info">
                  <div><strong>Data utworzenia:</strong> ${(new Date(p.created_at).toLocaleString('pl-PL')||"")}</div>
                  <div><strong>Kontakt:</strong> ${(p.contact.name||"")}</div>
                  <div><strong>E-mail:</strong> ${(p.contact.email||"")}</div>
                  <div><strong>Telefon:</strong> ${(p.contact.phone||"")}</div>
                </div>
                <div class="timeline">
                  <h3>Historia zamówienia:</h3>
                  <table>
                    <thead>
                      <tr>
                        <th>Etap</th>
                        <th>Data</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${p.timeline.map(item => `
                        <tr>
                          <td>${item.label}</td>
                          <td>${new Date(item.at).toLocaleString('pl-PL')}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `;
              botContainer.appendChild(card);
            });
          } else {
            if (/<a\s+href=/i.test(rawText)) botContainer.innerHTML = rawText;
            else botContainer.innerHTML = markdownToHTML(rawText);
          }
  
          chatBody.appendChild(botContainer);
          chatBody.scrollTop = chatBody.scrollHeight;
        })
        .catch(function (err) {
          try { typing.remove(); } catch(e){}
          console.error("Chat widget error:", err);
          var errorMessage = document.createElement("div");
          errorMessage.className = "bot-message";
          errorMessage.textContent = "Wystąpił błąd. Spróbuj ponownie.";
          chatBody.appendChild(errorMessage);
          chatBody.scrollTop = chatBody.scrollHeight;
        });
  
        inputField.value = "";
      }
  
      sendButton.addEventListener("click", sendMessage);
      inputField.addEventListener("keypress", function (e) { if (e.key === "Enter") sendMessage(); });
    }
  
    // Init
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();  